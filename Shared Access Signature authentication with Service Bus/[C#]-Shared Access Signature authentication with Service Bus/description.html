<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/9bf1b74c-1640-46af-84d3-e440c8f95162Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Shared Access Signature authentication with Service Bus</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Shared Access Signature authentication with Service Bus</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Service Bus, Windows Azure Service Bus
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Service Bus, Windows Azure Service Bus
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Cloud, Phone, Windows RT
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">5/29/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Shared-Access-Signature-0a88adf8">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Shared Access Signature (SAS) authentication with Service Bus</h1>
<div><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium"><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;">Shared Access Signature (SAS) authentication allows applications to authenticate to Windows Azure Service
 Bus using an access key configured on the namespace or the entity with specific rights associated with it. This key can then be used to generate a Shared Access Signature token that clients can use to authenticate to Service Bus.</span></span></div>
<div><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium">Authorization rules for SAS can be configured on a Service Bus namespace or a queue, topic or notification hub. This authorization rule consists of a KeyName, a Primary
 Key, a Secondary Key and associated access rights.</span></div>
<div><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium">For more details on using SAS authentication, please see:</span></div>
<ul>
<li><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium"><a href="http://msdn.microsoft.com/en-us/library/dn170477.aspx">Shared Access Signature Authentication with Service Bus</a></span>
</li><li><span style="line-height:107%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium"><a href="http://msdn.microsoft.com/en-us/library/dn205161.aspx" >How to use Shared Access Signature Authentication with Service Bus</a></span>
</li></ul>
<div>&nbsp;</div>
<h2>Prerequisites for using this sample:</h2>
<div>
<li style="padding-left:30px"><span style="font-size:small">A valid subscription to Windows Azure is required.</span>
</li><li style="padding-left:30px"><span style="font-size:small"><span style="font-size:small">Operations on the Service Bus namespace require certificate authentication. You will need to upload a management certificate for your Windows Azure subscription. You can
 upload a management certificate&nbsp;by selecting Settings in the left panel of the Windows Azure portal.&nbsp;(For details on Windows Azure Management Certificates, please see
<a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg981929.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/gg981929.aspx</a>.)</span></span>
</li></div>
<div>&nbsp;</div>
<h2><span>Building this sample:</span></h2>
<ul>
<li><span style="font-size:small">This sample requires Windows Azure SDK for .NET version 2.0 or later.
</span></li><li><span style="font-size:small">Install&nbsp;the <strong><em>Json.NET </em></strong>NuGet package through Visual Studio.</span>
</li><li><span style="font-size:small">Build the sample.</span> </li></ul>
<p><span style="font-size:small"></span></p>
<div><span style="font-size:20px; font-weight:bold">Details</span></div>
<div><span style="font-size:small">This sample&nbsp;demonstrates the use of Shared Access Signature authentication and authorization with Service Bus. It includes:</span></div>
<ul>
<li><span style="font-size:small">Operations on the Service Bus namespace&nbsp;to create, read and delete shared access authorization rules.
</span></li><li><span style="font-size:small">Operations on the Service Bus namespace to roll the keys for a shared access authorization rule.
</span></li><li><span style="font-size:small">Operations on&nbsp;a Service&nbsp;Bus entity to create, read and delete shared access authorization rules.
</span></li><li><span style="font-size:small">Runtime operations to send to &amp; receive from a Service Bus queue using a SharedAccessSignatureTokenProvider.
</span></li><li><span style="font-size:small">Runtime operations to send to &amp; receive from a Service Bus queue using a SharedAccessSignature token in a HTTP header.
</span></li></ul>
<div>&nbsp;</div>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">    // Code snippet for generating a SAS token for authorization with Service Bus
    TimeSpan sinceEpoch = DateTime.UtcNow - new DateTime(1970, 1, 1);
    var expiry = Convert.ToString((int)sinceEpoch.TotalSeconds &#43; 3600);
    string stringToSign = HttpUtility.UrlEncode(resourceUri) &#43; &quot;\n&quot; &#43; expiry;
    HMACSHA256 hmac = new HMACSHA256(Encoding.UTF8.GetBytes(key));

    var signature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(stringToSign)));
    var sasToken = String.Format(CultureInfo.InvariantCulture, &quot;SharedAccessSignature sr={0}&amp;sig={1}&amp;se={2}&amp;skn={3}&quot;, 
        HttpUtility.UrlEncode(resourceUri), HttpUtility.UrlEncode(signature), expiry, keyName);
</pre>
<div class="preview">
<pre class="csharp">&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Code&nbsp;snippet&nbsp;for&nbsp;generating&nbsp;a&nbsp;SAS&nbsp;token&nbsp;for&nbsp;authorization&nbsp;with&nbsp;Service&nbsp;Bus</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;TimeSpan&nbsp;sinceEpoch&nbsp;=&nbsp;DateTime.UtcNow&nbsp;-&nbsp;<span class="cs__keyword">new</span>&nbsp;DateTime(<span class="cs__number">1970</span>,&nbsp;<span class="cs__number">1</span>,&nbsp;<span class="cs__number">1</span>);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;expiry&nbsp;=&nbsp;Convert.ToString((<span class="cs__keyword">int</span>)sinceEpoch.TotalSeconds&nbsp;&#43;&nbsp;<span class="cs__number">3600</span>);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">string</span>&nbsp;stringToSign&nbsp;=&nbsp;HttpUtility.UrlEncode(resourceUri)&nbsp;&#43;&nbsp;<span class="cs__string">&quot;\n&quot;</span>&nbsp;&#43;&nbsp;expiry;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HMACSHA256&nbsp;hmac&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;HMACSHA256(Encoding.UTF8.GetBytes(key));&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;signature&nbsp;=&nbsp;Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(stringToSign)));&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;sasToken&nbsp;=&nbsp;String.Format(CultureInfo.InvariantCulture,&nbsp;<span class="cs__string">&quot;SharedAccessSignature&nbsp;sr={0}&amp;sig={1}&amp;se={2}&amp;skn={3}&quot;</span>,&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpUtility.UrlEncode(resourceUri),&nbsp;HttpUtility.UrlEncode(signature),&nbsp;expiry,&nbsp;keyName);&nbsp;
</pre>
</div>
</div>
</div>
<h1><em>&nbsp;</em></h1>

</div>


    </div>
</body>
</html>
